ARG ALPINE_VERSION=3.21

FROM node:22.14-alpine${ALPINE_VERSION} AS builder

WORKDIR /app

COPY package*.json package.init.cjs build-optimized.cjs tsconfig.json tsconfig.build.json ./
RUN node package.init.cjs && npm ci
COPY src ./src
RUN node build-optimized.cjs

RUN mkdir -p /etc/pki/rds && \
    wget -O /etc/pki/rds/global-bundle.pem \
    https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem


FROM node:22.14-alpine${ALPINE_VERSION}

WORKDIR /app

COPY --from=builder /app/dist ./dist
COPY --from=builder /etc/pki/rds /etc/pki/rds

RUN rm -rf /var/cache/apk/* && \
    find /usr/lib -name "*.a" -delete && \
    rm -rf /usr/share/man

ENV NODE_ENV=production \
  APP_PORT=8081

EXPOSE 8081
CMD ["node", "dist/main.js"]
